<!DOCTYPE html>
<html>
  <head>
    <title>La Fiesta Express</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <!-- Add Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
      .bg-mexican {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      }
      .text-mexican {
        color: #ff6b35;
      }
      .hover-mexican:hover {
        background-color: #ff6b35;
        color: white;
      }
      .nav-link {
        position: relative;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .nav-link:hover {
        color: #ff6b35;
        transform: translateY(-1px);
      }
      .nav-link::after {
        content: '';
        position: absolute;
        width: 0;
        height: 2px;
        bottom: -4px;
        left: 50%;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        transition: all 0.3s ease;
        transform: translateX(-50%);
      }
      .nav-link:hover::after {
        width: 100%;
      }
      .mobile-menu {
        transform: translateY(-100%);
        opacity: 0;
        transition: all 0.3s ease;
      }
      .mobile-menu.active {
        transform: translateY(0);
        opacity: 1;
      }
      .logo-image {
        background: transparent !important;
        mix-blend-mode: multiply;
      }
      /* Ensure mobile menu stays above other content */
      .mobile-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      .mobile-menu-overlay.active {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay md:hidden"></div>
    
    <!-- Navigation Header -->
    <nav class="bg-orange shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo -->
          <div class="flex items-center">
            <%= link_to root_path, class: "flex items-center", id: "logo-link" do %>
              <%= image_tag "chatXLogo.png", alt: "La Fiesta Express Logo", class: "h-14 w-auto mr-4 logo-image" %>
            <% end %>
          </div>

          <!-- Navigation Links -->
          <div class="hidden md:flex items-center space-x-8">
            <%= link_to "Menu", categories_path, class: "nav-link text-gray-700", onclick: "scrollToMenu(event)" %>
            <%= link_to "About", restaurant_info_path, class: "nav-link text-gray-700" %>
            
            <% if user_signed_in? %>
              <!-- Cart Icon -->
              <%= link_to orders_path, class: "relative text-gray-700 hover:text-mexican transition-colors p-2" do %>
                <i class="fas fa-shopping-cart text-lg"></i>
                <% if session[:order_id] %>
                  <span class="absolute -top-1 -right-1 bg-mexican text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-semibold">
                    <%= current_user.orders.find_by(id: session[:order_id])&.order_items&.count || 0 %>
                  </span>
                <% end %>
              <% end %>
              
              <!-- User Dropdown -->
              <div class="relative group">
                <button class="flex items-center text-gray-700 hover:text-mexican transition-colors font-medium px-3 py-2 rounded-lg hover:bg-gray-50">
                  <i class="fas fa-user-circle text-lg mr-2"></i>
                  <%= current_user.first_name %> 
                  <i class="fas fa-chevron-down ml-2 text-sm"></i>
                </button>
                <div class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                  <div class="py-2">
                    <%= link_to profile_path, class: "flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors" do %>
                      <i class="fas fa-user text-mexican mr-3"></i>
                      My Profile
                    <% end %>
                    
                    <%= link_to orders_path, class: "flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors" do %>
                      <i class="fas fa-receipt text-mexican mr-3"></i>
                      My Orders
                    <% end %>
                    
                    <%= link_to loyalty_cards_path, class: "flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors" do %>
                      <i class="fas fa-gift text-mexican mr-3"></i>
                      Loyalty Card
                    <% end %>
                    
                    <% if current_user.admin? %>
                      <div class="border-t border-gray-100 mt-2 pt-2">
                        <%= link_to admin_dashboard_path, class: "flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors" do %>
                          <i class="fas fa-cogs text-mexican mr-3"></i>
                          Admin Panel
                        <% end %>
                      </div>
                    <% end %>
                    
                    <div class="border-t border-gray-100 mt-2 pt-2">
                      <%= button_to logout_path, method: :delete, class: "flex items-center w-full px-4 py-3 text-red-600 hover:bg-red-50 transition-colors border-0 bg-transparent text-left" do %>
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        Sign Out
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <%= link_to "Login", login_path, class: "bg-mexican text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-all duration-300 font-medium shadow-md hover:shadow-lg" %>
            <% end %>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button id="mobile-menu-button" class="text-gray-700 hover:text-mexican p-2 rounded-lg hover:bg-gray-50 transition-colors" type="button">
              <i class="fas fa-bars text-lg"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Menu -->
      <div id="mobile-menu" class="mobile-menu md:hidden bg-white border-t border-gray-200 absolute w-full shadow-lg z-50">
        <div class="px-4 py-4 space-y-3">
          <%= link_to "Menu", categories_path, class: "block text-gray-700 hover:text-mexican font-medium py-2 transition-colors" %>
          <%= link_to "About", restaurant_info_path, class: "block text-gray-700 hover:text-mexican font-medium py-2 transition-colors" %>
          
          <% if user_signed_in? %>
            <div class="border-t border-gray-200 pt-3 mt-3">
              <div class="flex items-center mb-3">
                <i class="fas fa-user-circle text-mexican text-lg mr-2"></i>
                <span class="font-medium text-gray-800"><%= current_user.first_name %></span>
              </div>
              
              <%= link_to profile_path, class: "block text-gray-700 hover:text-mexican py-2 pl-4 transition-colors" do %>
                <i class="fas fa-user mr-2"></i> My Profile
              <% end %>
              
              <%= link_to orders_path, class: "block text-gray-700 hover:text-mexican py-2 pl-4 transition-colors" do %>
                <i class="fas fa-shopping-cart mr-2"></i> My Orders
                <% if session[:order_id] %>
                  <span class="bg-mexican text-white text-xs rounded-full px-2 py-1 ml-2">
                    <%= current_user.orders.find_by(id: session[:order_id])&.order_items&.count || 0 %>
                  </span>
                <% end %>
              <% end %>
              
              <%= link_to loyalty_cards_path, class: "block text-gray-700 hover:text-mexican py-2 pl-4 transition-colors" do %>
                <i class="fas fa-gift mr-2"></i> Loyalty Card
              <% end %>
              
              <% if current_user.admin? %>
                <%= link_to admin_dashboard_path, class: "block text-gray-700 hover:text-mexican py-2 pl-4 transition-colors" do %>
                  <i class="fas fa-cogs mr-2"></i> Admin Panel
                <% end %>
              <% end %>
              
              <%= button_to logout_path, method: :delete, class: "block w-full text-left text-red-600 hover:text-red-800 py-2 pl-4 transition-colors border-0 bg-transparent mt-2 pt-2 border-t border-gray-200" do %>
                <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
              <% end %>
            </div>
          <% else %>
            <div class="border-t border-gray-200 pt-3 mt-3">
              <%= link_to "Login", login_path, class: "block bg-mexican text-white px-4 py-3 rounded-lg hover:bg-orange-600 transition-colors font-medium text-center" %>
            </div>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    <% if notice %>
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mx-4 mt-4" role="alert">
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-2"></i>
          <%= notice %>
        </div>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mx-4 mt-4" role="alert">
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <%= alert %>
        </div>
      </div>
    <% end %>

    <!-- Main Content -->
    <main>
      <%= yield %>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
      <div class="max-w-7xl mx-auto px-4 py-10 space-y-8">
        
        <!-- Brand / Description -->
        <div>
          <h3 class="text-2xl font-semibold mb-2">La Fiesta Express</h3>
          <p class="text-gray-300">Authentic Mexican cuisine made with love and tradition.</p>
        </div>

        <!-- Info Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center text-gray-300">
          
          <!-- Location -->
          <div class="flex flex-col items-center">
            <i class="fas fa-map-marker-alt text-red-500 text-3xl mb-2"></i>
            <p class="font-semibold text-white">Location</p>
            <p class="text-gray-400">
              <% if @restaurant_info %>
                <%= @restaurant_info.street %>, <%= @restaurant_info.city %>, <%= @restaurant_info.state %> <%= @restaurant_info.zip_code %>
              <% else %>
                1133 West Main Street, Troy, OH
              <% end %>
            </p>
          </div>

          <!-- Hours -->
          <div class="flex flex-col items-center">
            <i class="fas fa-clock text-red-500 text-3xl mb-2"></i>
            <p class="font-semibold text-white">Hours Today</p>
            <p class="text-gray-400">
              <% if @restaurant_info %>
                <% 
                  today = Date.current.strftime("%A").downcase
                  hours_method = "#{today}_hours"
                  todays_hours = @restaurant_info.respond_to?(hours_method) ? @restaurant_info.send(hours_method) : nil
                %>
                <%= todays_hours || "Call for hours" %>
              <% else %>
                11:00 AM – 9:30 PM
              <% end %>
            </p>
          </div>

          <!-- Phone -->
          <div class="flex flex-col items-center">
            <i class="fas fa-phone text-red-500 text-3xl mb-2"></i>
            <p class="font-semibold text-white">Call Us</p>
            <p class="text-gray-400"><%= @restaurant_info&.phone || "937-703-1371" %></p>
          </div>

        </div>

      </div>
    </footer>

    <!-- JavaScript for Mobile Menu -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const logoLink = document.getElementById('logo-link');
        
        if (mobileMenuButton && mobileMenu && mobileMenuOverlay) {
          
          // Function to close mobile menu
          function closeMobileMenu() {
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
            const icon = mobileMenuButton.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
          
          // Function to open mobile menu
          function openMobileMenu() {
            mobileMenu.classList.add('active');
            mobileMenuOverlay.classList.add('active');
            const icon = mobileMenuButton.querySelector('i');
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          }
          
          // Toggle mobile menu
          mobileMenuButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (mobileMenu.classList.contains('active')) {
              closeMobileMenu();
            } else {
              openMobileMenu();
            }
          });
          
          // Close mobile menu when clicking overlay
          mobileMenuOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            closeMobileMenu();
          });
          
          // Close mobile menu when clicking menu links
          const mobileMenuLinks = mobileMenu.querySelectorAll('a:not([method])');
          mobileMenuLinks.forEach(link => {
            link.addEventListener('click', function() {
              closeMobileMenu();
            });
          });
          
          // Prevent menu from interfering with desktop dropdowns
          document.addEventListener('click', function(event) {
            // Only handle clicks on mobile
            if (window.innerWidth < 768) {
              const isMenuButton = event.target.closest('#mobile-menu-button');
              const isMenuContent = event.target.closest('#mobile-menu');
              const isOverlay = event.target.closest('#mobile-menu-overlay');
              
              if (!isMenuButton && !isMenuContent && !isOverlay) {
                closeMobileMenu();
              }
            }
          });
        }
      });

      // Function to scroll to menu section on categories page
      function scrollToMenu(event) {
        // Check if we are on the categories page (root page)
        if (window.location.pathname === '/' || window.location.pathname === '/categories') {
          event.preventDefault();
          
          // Look for menu section - could be categories grid or menu items
          const menuSection = document.querySelector('#menu-section') || 
                             document.querySelector('.categories-grid') || 
                             document.querySelector('[data-menu-section]') ||
                             document.querySelector('main');
          
          if (menuSection) {
            menuSection.scrollIntoView({ 
              behavior: 'smooth',
              block: 'start'
            });
          }
        }
        // If not on categories page, let the link work normally to navigate there
      }
    </script>

  </body>
</html>